# Design-Doc: Чат-бот / RAG-система

/ основан на шаблоне команды [Reliable ML](https://github.com/IrinaGoloshchapova/ml_system_design_doc_ru/blob/main/ML_System_Design_Doc_Template.md) /

(Заполняется проектной командой: бизнес-заказчик, ML/инженеры, продуктовая команда)

## 1. Контекст проекта

### 1.1 Бизнес-задача
	•	Описание проблемы/вызова, который пытаемся решить (например: ускорение ответа операторов, автоматизация FAQ, повышение удовлетворённости клиентов).
	•	Почему именно чат-бот / RAG-система имеет смысл.
	•	Каковы критерии успеха с точки зрения бизнеса.

Проблема в том, что летом и во время сессии у абитуриентов и студентов вуза появляется огромное количество вопросов, связанных с порядком проведения тех или иных мероприятий. Большинство ответов на эти вопросы хранится в ПОПАТКУСе, однако зачастую там трудно найти конкретный ответ на интересующий вопрос, поэтому этими вопросами заваливают УО и других сотрудников университета, из-за чего среднее время ответа кратно увеличивается

Чат-бот позволит автоматизировать процесс ответов на типичные и повторяющиеся вопросы, которые не требуют обращения к службе поддержки университета.

Успехом можно считать запуск бота и внедрение в работу вуза

### 1.2 Целевая аудитория и пользователи
	•	Кто будет пользоваться ботом: внутренние сотрудники, клиенты, партнёры.
	•	Какие сценарии использования: текстовый чат, голосовой интерфейс, мессенджеры, веб-виджет.
	•	Какова предполагаемая нагрузка: число сессий/пользователей, пиковые часы.

Целевой аудиторией бота являются клиенты: студенты и абитуриенты университета
Сценарии использования: текстовый чат в Telegram
Предполагаемая нагрузка: до 1000 пользователей в момент набора новых студентов и периоды сессий/пересдач

### 1.3 Ограничения и допущения
	•	Что нельзя/не будет делать (например: не интегрируемся с X, не обрабатываем Y).
	•	Предположения о данных, инфраструктуре, требованиях к безопасности, к нормативам.

Мы не хотим отвечать на какие-либо вопросы не касающиеся имеющейся информации на сайте вуза, соответственно бот должен обьяснить это

Бот не подразмуевает регистрацию и хранение каких либо данных пользователей, его личные данные, тикет и прочее должны храниться локально

## 2. Архитектура решения

### 2.1 Общая схема
	•	Диаграмма архитектуры: фронт-энд (чат-интерфейс) → API → RAG-движок → база/хранилище знаний → LLM → пост-обработка.
	•	Основные компоненты и их роли.

БД будет храниться локально, промпт будет отдельным файлом
Порядок обработки запроса приблизительно следующий: получение запроса, его нормализация для поиска, вычисление embeddings, получение top-k и метаданных из chromadb, проверка достаточности информации (в случае недостаточности отдельный скрипт с отказом), сбор промпта, вызов llm, постобработка и возрат пользователю

### 2.2 Хранилище знаний / документооборот
	•	Источники знаний: внутренние документы, база знаний, Wiki, чаты, внешние API.
	•	Предобработка: парсинг, нормализация, категоризация.
	•	Индексация: векторизация (embedding), ключевые слова, метаданные.
	•	Обновление данных: как часто синхронизируется, как обрабатываются новые документы.

Источник знаний -- документ ПОПАТКУС, который можно найти на официальном сайте НИУ ВШЭ
Данные будут обновляться соответственно с выходом новой редакции ПОПАТКУСа


### 2.3 Retrieval + Generation
	•	Retrieval: какой движок (Qdrant, FAISS, Elastic Vectorembedding и т.д.), конфигурации (embedding модель, размер векторов, k, threshold).
	•	Generation: какая LLM используется (локально / облако), с какими промпт-шаблонами.
	•	Контроль ответа: фильтрация, шаблоны, гарантия качества, fallback стратегия.
-- технические решения, можно к КТ1 не писать, но просто прикинуть, что будет актуально; но аргументировать выбор перед защитой на основе бизнес-требований.

### 2.4 Интеграции и интерфейсы
	•	Внешние API и сервисы: чат-интерфейс, CRM, база пользователей, логирование.
	•	Протоколы: REST, gRPC, WebSockets, Webhook.
	•	UI/UX: как выглядит чат, переходы, кнопки, предложения.
	•	Мониторинг: логирование запросов/ответов, аналитика, алерты.

### 2.5 Инфраструктура и развертывание
	•	Архитектурный стек: контейнеры (Docker), оркестрация (Kubernetes), серверless.
	•	Среды: dev/test/prod.
	•	Требования к вычислениям: GPU или CPU, память, хранилище.
	•	Безопасность: аутентификация, авторизация, шифрование, GDPR/нормы.
	•	Масштабирование: горизонтальное, резервирование, локализация.

## 3. Данные и качество знаний

Данные, которыми будет пользоваться бот, лежат в открытом доступе, соответственно никаких дополнительных фильтраций проводить не нужно

### 3.1 Сбор и предобработка данных
	•	Источники документов/текста, форматы (PDF, HTML, TXT, базы данных).
	•	Шаги предобработки: токенизация, очистка, выделение сущностей, сегментация.
	•	Метаданные: добавление тегов, категоризация, дата, автор.
Документ ПОПАТКУС представлен в формате PDF, что упростит его парсинг
Предобработка: разбиение на страницы, очистка от мусора, сегментация с покрытием
Метаданные: каждый фрагмент имеет уникальный идентификатор, номер страницы, тип информации

### 3.2 Векторизация и индексирование
	•	Модель embedding: название, версия, особенности (например multiling, domain-specific).
	•	Параметры индекса: размер, алгоритм, метрики (cosine, euclid), shards/replicas.
	•	Стратегии обновления: инкрементальное обновление, пересборка индекса.

### 3.3 Метрики качества знаний
	•	Покрытие: % документов в базе относящихся к сценариям.
	•	Актуальность: как быстро база обновляется, как отражаются изменения.
	•	Консистентность: нет дубликатов, нет противоречивых данных.
	•	Проверка: ручная ревизия, спотыкаемые примеры, A/B-тестирование.

## 4. Модель и генерация

### 4.1 Выбор LLM и промптинг
	•	Указание модели: объяснение, почему выбранa.
	•	Промпт-шаблоны: входные данные, контекст, инструкции, формат ответа.
	•	Ограничения: максимальная длина, токены, скорость генерации.

### 4.2 Контроль качества ответов
	•	Метрики: точность, полнота/coverage, полезность, удовлетворённость пользователя.
	•	Оценка ошибок: нежелательные ответы, hallucinations, офтопик.
	•	Механизмы: ручной ревью, эвристики (например “если confidence < x, дефолтный ответ”), fallback на статический контент.

### 4.3 Обучение/дообучение
	•	Если предусмотрено fine-tuning или RLHF: данные, процесс, метрики.
	•	Версионирование моделей, rollback план.

## 5. UX / пользовательский опыт

Важно: пункт 5.1 -- он определяет частично БФТ. Что делать, если не смогли ответить? Продумать, где мы можем накосячить и как это обработать?

### 5.1 Сценарии взаимодействия
	•	Основные сценарии: приветствие, поиск по знаниям, уточняющий вопрос, многотуровый диалог.
	•	Исключительные сценарии: нет ответа, не поняли, баг, перенос к оператору.

### 5.2 Диалоговая логика
	•	Как обрабатываются состояния: single-turn, multi-turn.
	•	Как ведётся контекст: окно истории, память пользователя.
	•	Как эстетически выглядят ответы (тон, стиль, язык, эмодзи/микроинтеракции).
Храним ли мы историю общения с пользователем? Если да, то как? В каком тоне отвечаем?

### 5.3 Метрики UX
	•	Время до первого ответа, % возврата пользователей, NPS, рейтинг полезности ответа.
	•	Логирование взаимодействий, сбор отзывов.
Как быстро нужно отвечать? Может быть надо как-то взаимодействовать с пользователем в рамках получения фидбэка (лайк/дизлайк). Нужно ли логгировать работу бота для отслеживания качества работы?

## 6. Безопасность, соответствие и этика
	•	Обработка персональных данных, разрешения пользователей.
	•	Устранение вредоносного/нежелательного контента, фильтры.
	•	Прозрачность: уведомление о том, что это бот, логика сбора данных.
	•	Регулирования и нормативы (GDPR, внутренние политики).

Бот не собирает никакой информации о пользователе, он является поисковиком с возможностью пояснения интересующей информации.
Поскольку информацию бот собирает исключительно с одного документа, фильтрация при поиске не требуется
Бот первым сообщением уведомляет о своем функционале
Бот никаким образом не обсуждает внутренних сотрудников университета, при некорректном запросе, бот отказывает, что он должен делать, это предоставлять информацию имеющуюся в ПОПАТКУСе

## [OPTIONAL] 7. План внедрения и эксплуатации

Скорее актуально для рабочего проекта и его запуска.
### 7.1 Этапы проекта
	•	Фаза 0: исследование/документирование.
	•	Фаза 1: MVP (минимально жизнеспособный бот).
	•	Фаза 2: расширение функциональности, RAG-дополнения.
	•	Фаза 3: масштабирование, оптимизация.
	•	Вехи, сроки, ответственные.

### 7.2 Поддержка и эксплуатация
	•	Кто отвечает за поддержку (SRE, DevOps, чат-бот команда).
	•	Мониторинг: логирование ошибок, SLA, alerts, dashboards.
	•	Обновление знаний: план синхронизации, процесс ревью.
	•	Метрики эксплуатации: uptime, latency, cost per session.

## 8. Риски и допущения
	•	Список основных рисков (например: модель даёт неточные ответы, база знаний недостаточна, бюджет/ресурсы ограничены).
	•	Вероятность и влияние, стратегия уменьшения (mitigation).
	•	Ключевые допущения, которые не проверены.

## 9. [OPTIONAL] Бюджет и ресурсы
Скорее актуально для рабочего проекта и его запуска.
	•	Человеческие ресурсы: ML инженер, NLP инженер, DevOps, UX дизайнер, контент-менеджер.
	•	Технологические ресурсы: вычислительные ресурсы (GPU/CPU), лицензии, облачные сервисы.
	•	Примерные затраты (CAPEX, OPEX).
	•	ROI оценки: ожидаемое снижение затрат, ускорение ответа, рост удовлетворённости.

## 10. Приложения
Что-то, что стоит прописать в тексте работы во введении.
	•	Словарь терминов и аббревиатур.
	•	Ссылки на специфические документы: требования безопасности, регламент, UX-гайд, API-спецификации.
	•	Диаграммы, схемы, mock-up интерфейсов.
	•	Чек-лист готовности к запуску.
